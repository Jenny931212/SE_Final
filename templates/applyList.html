<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body >
<a href="/logout">Logout</a>
<P>
	<a href="/">Back Home</a>
</P>
{% raw %}
<div id="main">
	<h1>我的接案</h1>
	<hr/>
	<div v-for="item in dat" :key="item.id">
		
		<div v-if="item.winner === currentUser">
		<div v-if="item.finish == false">
			
			<p>
				案件編號:{{ item.id }}
			</p>
			<p>
				委託內容:{{ item.content }}
			</p>
			<p>
				委託人:{{ item.username }}
			</p>
			<p>
				接案價格:{{ item.winnerprice }}
			</p>

			<div v-if="item.filename == null">
				<p>
					<em>(尚未交件)</em>
				</p>
			</div>
			<div v-else>
				<p>
					<em>(已交件)</em>
			        <a :href="'/uploads/' + item.filename" :download="item.filename">下載交件檔案</a>
				</p>
			</div>
			<input type='button' @click="methods.readPost(item.id)" value="檢視詳情/Issue">
			<hr/>
		</div>
		</div>
	</div>

	<div>
	<h1>歷史接案</h1>
	<hr/>
    <div v-for="item in dat" :key="item.id"> 
		<div v-if="item.winner === currentUser">
		<div v-if="item.finish == true">
	    	<p>
			案件編號:{{item.id}}
			</p>
			<p>
			委託內容:{{item.content}}
			</p>
			<p>
			委託人:{{ item.username}}
			</p>
			<p>
			接案價格:{{ item.winnerprice }}
			</p>
            <div v-if="item.filename">
                <a :href="'/uploads/' + item.filename" :download="item.filename">下載最終交件檔案</a>
            </div>
	    <hr/>
		</div>
		</div>
	</div>
	</div>

    <div v-if="rec.id">
        <h2>案件詳情與問題追蹤 (Post ID: {{ rec.id }})</h2>
        <p>
            委託人: {{ rec.username }} |
            接案價格: {{ rec.winnerprice }} |
            狀態: {{ rec.finish ? '已最終結案' : '處理中' }}
        </p>
        <p>
            委託內容: {{ rec.content }}
        </p>
        <hr/>
        
        <div v-if="rec.finish == false">
            <h3>上傳完成檔案 (供委託人檢視)</h3>
            <div v-if="rec.filename">
                <p>目前檔案: <a :href="'/uploads/' + rec.filename" :download="rec.filename">{{ rec.filename }}</a></p>
            </div>
            <div>
                <input type="file" name="uploadedFile" @change="methods.handleFileChange">
                <input type="button" value="上傳/更新檔案" @click="methods.uploadFile(rec.id)">
            </div>
            <hr/>
        </div>

        <h3>Issue 列表 (共 {{ issuesList.length }} 個)</h3>
        <div v-for="issue in issuesList" :key="issue.id" style="border: 1px solid #ccc; margin-bottom: 10px; padding: 10px;">
            <p>
                Issue ID: {{ issue.id }}| 
                狀態:  <span :style="{ color: issue.status === 'open' ? 'red' : 'green' }">{{ issue.status }}</span> | 
                開啟者: {{ issue.opener_user }} | 
                <small>{{ issue.created_at }}</small>
            </p>
            <p>
                {{ issue.title }}
            </p>
            
            <button @click="selectedIssueId === issue.id ? selectedIssueId = null : methods.loadComments(issue.id)">
                {{ selectedIssueId === issue.id ? '隱藏留言' : '查看/回覆留言' }}
            </button>
            
            <div v-if="selectedIssueId === issue.id">
                <h4>留言 (Comments)</h4>
                <div v-for="comment in commentsList" :key="comment.id" style="background: #f0f0f0; margin-top: 5px; padding: 5px;">
                    <p>
                        {{ comment.comment_user }}: {{ comment.content }}
                        <small>({{ comment.created_at }})</small>
                    </p>
                </div>
                
                <div v-if="issue.status === 'open' && rec.finish === false">
                    <textarea v-model="newCommentContent" placeholder="新增回覆..." rows="2"></textarea><br>
                    <button @click="methods.addComment">送出回覆</button>
                </div>
                <div v-else>
                    <p><em>(此 Issue 已關閉或案件已結案，無法新增留言)</em></p>
                </div>
            </div>
        </div>
        </div>
    </div>
{% endraw %}
<script type="text/javascript">
const { createApp, ref, reactive, onMounted } = Vue;

app=createApp({
  setup() {
	const newContent = ref('');
	const newPrice = ref('');
	const role=ref('admin');
	const rec=ref({});
	const dat=ref([]);
	const selectedFile = ref(null);
	const applies=ref([]);
	const currentUser = ref('');
	
    // === Issue Tracker 新增狀態 (與 postList.html 相似) ===
    const issuesList = ref([]);
    const commentsList = ref([]);
    const newCommentContent = ref(''); // 只需要留言內容
    const selectedIssueId = ref(null);
    // ======================================

	const methods={
		loadList: () => {
			let url="/getPostsJson";
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) 
			.then(function(json){
				dat.value=json;
			})
		},
		loadUser: () => {
            fetch('/getUser')
                .then(res => res.json())
                .then(data => {
                    if (data.username) {
                        currentUser.value = data.username;
                    } 
                });
        },
		loadApplies: (id) => {
		    let url="/readApplyJson/"+id;
		    fetch(url,{
		        method: 'GET'
		    })
		    .then(function(res){return res.json(); })
		    .then(function(json){
		        applies.value=json; 
		    })
		},

		readPost: (id) => {
		  // 載入案件詳情
			let url="/readPostJson/"+id;
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) 
			.then(function(json){
				rec.value=json;
				applies.value = [];
				methods.loadApplies(id);
                methods.loadIssues(id); // <<< 載入 Issues
			})
		},	
        
        // **********************************************
        // === Issues Tracker 新增邏輯 (接案人) ===
        // **********************************************
        loadIssues: (postId) => {
            let url = `/api/issues/get/${postId}`;
            fetch(url)
                .then(res => res.json())
                .then(json => {
                    issuesList.value = json;
                    commentsList.value = []; 
                    selectedIssueId.value = null; 
                })
                .catch(error => console.error('Error loading issues:', error));
        },
        
        loadComments: (issueId) => {
            // 切換選中的 Issue ID，如果點擊同一個則隱藏
            if (selectedIssueId.value === issueId) {
                selectedIssueId.value = null;
                commentsList.value = [];
                return;
            }
            selectedIssueId.value = issueId;
            
            let url = `/api/issues/comments/${issueId}`;
            fetch(url)
                .then(res => res.json())
                .then(json => {
                    commentsList.value = json;
                })
                .catch(error => console.error('Error loading comments:', error));
        },

        addComment: () => {
            if (!selectedIssueId.value || !newCommentContent.value) return;
            
            // 找到當前選中的 issue 確保它仍然是 open
            const currentIssue = issuesList.value.find(i => i.id === selectedIssueId.value);
            if (!currentIssue || currentIssue.status !== 'open') {
                alert("此 Issue 已關閉，無法回覆。");
                return;
            }

            const formData = new FormData();
            formData.append('issue_id', selectedIssueId.value);
            formData.append('content', newCommentContent.value);

            fetch('/api/issues/comment/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    newCommentContent.value = '';
                    methods.loadComments(selectedIssueId.value); // 重新載入留言
                } else {
                    alert(`新增留言失敗: ${data.detail}`);
                }
            })
            .catch(error => console.error('Error adding comment:', error));
        },
        // ==============================================

		addPost: (content) => { /* ... */ },
		addPrice: (id,price) => { /* ... */ },
		addWinner: (id, item) => { /* ... */ },
		delPost: (id) => { /* ... */ },

		handleFileChange: (event) => {
			selectedFile.value = event.target.files[0];
		},		
		uploadFile: async (id) => { 
			if (selectedFile.value) {
				const allowedTypes = ['image/png', 'image/jpeg', 'application/pdf'];
				if (!allowedTypes.includes(selectedFile.value.type)) {
					console.log('Invalid file type. Please upload a PNG, JPEG, or PDF.');
					selectedFile.value = null; 
				} else {
					console.log('Selected file:', selectedFile.value.name);
					console.log('post id:', id); 
					const formData = new FormData();
					formData.append('uploadedFile', selectedFile.value); 
					formData.append('msg', id); 
					try {
						const response = await fetch('/api/upload', {
							method: 'POST',
							body: formData,
						});

						if (response.ok) {
							const data = await response.json();
							console.log('Upload successful:', data);
							selectedFile.value = null;
							methods.readPost(id); // 重新載入詳情
                            methods.loadList(); // 重新載入列表
						} else {
						  console.error('Upload failed:', response.statusText);
						}
					} catch (error) {
						console.error('Network error during upload:', error);
					}
				}
			} else {
				console.log("No file selected.");
			}
		}
	}; 

	onMounted(() => {
		methods.loadList();
		methods.loadUser();
	});

    return { 
        currentUser,newContent,newPrice, rec, dat,role,selectedFile,methods,applies,
        issuesList, commentsList, newCommentContent, selectedIssueId
    };
  }
}).mount('#main');
</script>

</body></html>